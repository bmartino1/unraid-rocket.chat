###############################################################################
#  Rocket.Chat – Unraid Multi-Stack Docker Compose
#  https://github.com/bmartino1/unraid-rocket.chat
#
#  Services: MongoDB 8 (replica-set) · NATS · Rocket.Chat · Nginx reverse proxy
#
#  Usage:
#    1.  git clone https://github.com/bmartino1/unraid-rocket.chat.git \
#            /mnt/user/appdata/unraid-rocket.chat
#    2.  cd /mnt/user/appdata/unraid-rocket.chat && bash setup.sh
#    3.  docker-compose up -d
#
#  Ports exposed on the Unraid host (avoids 80/443 conflict with Unraid WebUI):
#    60080  → HTTP  (Nginx → Rocket.Chat)
#    60443  → HTTPS (Nginx → Rocket.Chat, self-signed by default)
#    3000   → Direct Rocket.Chat (optional, disable via RC_HOST_PORT in .env)
###############################################################################

networks:
  rocketchat_net:
    name: rocketchat_net
    driver: bridge

services:

  # ===================================================================
  #  MongoDB  –  Community Server with automatic replica-set init
  # ===================================================================
  mongodb:
    image: mongodb/mongodb-community-server:${MONGODB_VERSION:-8.2-ubi8}
    container_name: rocketchat-mongodb
    restart: unless-stopped
    networks:
      - rocketchat_net
    volumes:
      - ${DATA_DIR:-/mnt/user/appdata/unraid-rocket.chat}/mongodb:/data/db
    environment:
      MONGODB_REPLICA_SET_NAME: ${MONGO_RS:-rs0}
      MONGODB_PORT_NUMBER: ${MONGO_PORT:-27017}
      MONGODB_INITIAL_PRIMARY_HOST: mongodb
    entrypoint: >
      bash -c "
        mongod --replSet $${MONGODB_REPLICA_SET_NAME} --bind_ip_all --port $${MONGODB_PORT_NUMBER} &
        MONGOD_PID=$$!;
        echo '[mongo-init] Waiting for mongod to accept connections...';
        for i in $$(seq 1 60); do
          if mongosh --port $${MONGODB_PORT_NUMBER} --quiet --eval \"db.adminCommand('ping')\" >/dev/null 2>&1; then
            break;
          fi;
          sleep 1;
        done;
        echo '[mongo-init] Initiating replica set...';
        mongosh --port $${MONGODB_PORT_NUMBER} --quiet --eval \"
          try {
            rs.status();
            print('Replica set already initialized.');
          } catch(e) {
            rs.initiate({
              _id: '$${MONGODB_REPLICA_SET_NAME}',
              members: [{ _id: 0, host: '$${MONGODB_INITIAL_PRIMARY_HOST}:$${MONGODB_PORT_NUMBER}' }]
            });
            print('Replica set initiated.');
          }
        \";
        echo '[mongo-init] Waiting for PRIMARY...';
        for i in $$(seq 1 60); do
          if mongosh --port $${MONGODB_PORT_NUMBER} --quiet --eval 'db.hello().isWritablePrimary' 2>/dev/null | grep -q true; then
            echo '[mongo-init] PRIMARY confirmed.';
            break;
          fi;
          sleep 1;
        done;
        wait $${MONGOD_PID};
      "
    healthcheck:
      test: ["CMD", "mongosh", "--port", "${MONGO_PORT:-27017}", "--quiet", "--eval", "db.hello().isWritablePrimary"]
      interval: 15s
      timeout: 10s
      retries: 12
      start_period: 30s
    labels:
      net.unraid.docker.managed: "composeman"
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-rocket.chat/main/images/mongodb.png"
      net.unraid.docker.shell: "/bin/bash"
      folder.view: "rocketchat"

  # ===================================================================
  #  NATS  –  Microservices transport
  # ===================================================================
  nats:
    image: docker.io/nats:${NATS_VERSION:-2.11-alpine}
    container_name: rocketchat-nats
    restart: unless-stopped
    networks:
      - rocketchat_net
    command: --http_port 8222 --max_payload 1048576
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    labels:
      net.unraid.docker.managed: "composeman"
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-rocket.chat/main/images/nats.png"
      net.unraid.docker.shell: "/bin/sh"
      folder.view: "rocketchat"

  # ===================================================================
  #  Rocket.Chat  –  Application server
  # ===================================================================
  rocketchat:
    image: ${RC_IMAGE:-registry.rocket.chat/rocketchat/rocket.chat}:${RC_RELEASE:-latest}
    container_name: rocketchat
    restart: unless-stopped
    networks:
      - rocketchat_net
    depends_on:
      mongodb:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      ROOT_URL: ${ROOT_URL:-http://localhost:60080}
      PORT: ${RC_PORT:-3000}
      BIND_IP: "0.0.0.0"

      # MongoDB
      MONGO_URL: "mongodb://mongodb:${MONGO_PORT:-27017}/${MONGO_DB:-rocketchat}?replicaSet=${MONGO_RS:-rs0}"
      MONGO_OPLOG_URL: "mongodb://mongodb:${MONGO_PORT:-27017}/local?replicaSet=${MONGO_RS:-rs0}"

      # NATS transport
      TRANSPORTER: "nats://nats:4222"

      # Deployment metadata
      DEPLOY_METHOD: docker
      DEPLOY_PLATFORM: compose-unraid

      # Registration token (optional – obtain from cloud.rocket.chat)
      REG_TOKEN: ${REG_TOKEN:-}

      # Prometheus metrics (optional, harmless if unused)
      LICENSE_DEBUG: "true"
      OVERWRITE_SETTING_Prometheus_Enabled: "${PROMETHEUS_ENABLED:-true}"
      OVERWRITE_SETTING_Prometheus_Port: "${METRICS_PORT:-9458}"
    ports:
      # Direct access – set RC_HOST_PORT= (empty) in .env to disable
      - "${RC_BIND_IP:-0.0.0.0}:${RC_HOST_PORT:-3000}:${RC_PORT:-3000}"
    volumes:
      - ${DATA_DIR:-/mnt/user/appdata/unraid-rocket.chat}/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:3000/api/info').then(r=>{if(!r.ok)throw 1})"]
      interval: 20s
      timeout: 10s
      retries: 15
      start_period: 60s
    labels:
      net.unraid.docker.managed: "composeman"
      net.unraid.docker.webui: "http://[IP]:[PORT:3000]"
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-rocket.chat/main/images/rocketchat.png"
      net.unraid.docker.shell: "/bin/bash"
      folder.view: "rocketchat"

  # ===================================================================
  #  Nginx  –  Reverse proxy (HTTP 60080 / HTTPS 60443)
  # ===================================================================
  nginx:
    image: docker.io/nginx:${NGINX_VERSION:-stable-alpine}
    container_name: rocketchat-nginx
    restart: unless-stopped
    networks:
      - rocketchat_net
    depends_on:
      rocketchat:
        condition: service_healthy
    ports:
      - "${NGINX_BIND_IP:-0.0.0.0}:${NGINX_HTTP_PORT:-60080}:80"
      - "${NGINX_BIND_IP:-0.0.0.0}:${NGINX_HTTPS_PORT:-60443}:443"
    volumes:
      - ${DATA_DIR:-/mnt/user/appdata/unraid-rocket.chat}/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ${DATA_DIR:-/mnt/user/appdata/unraid-rocket.chat}/nginx/certs:/etc/nginx/certs:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:80/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      net.unraid.docker.managed: "composeman"
      net.unraid.docker.webui: "https://[IP]:[PORT:443]"
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-rocket.chat/main/images/nginx.png"
      net.unraid.docker.shell: "/bin/sh"
      folder.view: "rocketchat"
